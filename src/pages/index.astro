---
import GameCard from '../components/GameCard.astro';
import listaDeJogos from '../data/jogos.json';
import PerfilJogador from '../components/PerfilJogador.astro';

const categorias = [...new Set(listaDeJogos.map((jogo) => jogo.categoria))];
---

<html lang="pt">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/png" href="/logo.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>GAMER PORTAL | Nexus Edition</title>
    
    <script is:inline>
      (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','GTM-PQHFF59B');
    </script>
  </head>
  
  <body>
    <div class="space-bg">
      <div class="stars"></div>
      <div class="retro-grid"></div>
      <div class="vignette"></div>
    </div>

    <header>
      <nav class="top-nav">
        <a href="/" class="logo-container">
          <h1 class="glitch-logo" data-text="GAMERPORTAL">GAMER<span class="pink">PORTAL</span></h1>
        </a>
        <div class="user-area">
          <PerfilJogador />
        </div>
      </nav>

      <div class="hero-section">
        <div class="search-wrapper">
          <div class="search-glow"></div>
          <input type="text" id="searchBox" placeholder="O que vamos jogar hoje?..." />
          <kbd class="search-hint">CTRL + K</kbd>
        </div>

        <div class="filter-bar">
          <div class="filter-scroll">
            <button class="filter-chip active" data-cat="todos">Explorar Tudo</button>
            <button class="filter-chip fav" data-cat="favoritos">‚ù§Ô∏è Os Meus Favoritos</button>
            <div class="divider"></div>
            {categorias.map((cat) => (
              <button class="filter-chip" data-cat={cat}>{cat}</button>
            ))}
          </div>
        </div>
      </div>
    </header>

    <main class="content">
      <div class="game-grid" id="mainGrid">
        {listaDeJogos.map((jogo) => (
          <div 
            class="game-card-wrapper" 
            data-titulo={jogo.titulo.toLowerCase()} 
            data-categoria={jogo.categoria}
            data-id={jogo.id}
          >
            <GameCard 
              id={jogo.id}
              titulo={jogo.titulo} 
              thumb={jogo.imagem || "/capas/placeholder.jpg"} 
              categoria={jogo.categoria} 
            />
          </div>
        ))}
      </div>

      <div id="empty-state" class="hidden">
        <div class="empty-icon">üïπÔ∏è</div>
        <h2>Nenhum jogo detetado no radar...</h2>
        <p>Tenta pesquisar por outro termo ou limpa os filtros.</p>
      </div>
    </main>

    <script is:inline>
      const searchBox = document.getElementById('searchBox');
      const filterBtns = document.querySelectorAll('.filter-chip');
      const games = document.querySelectorAll('.game-card-wrapper');
      const emptyState = document.getElementById('empty-state');
      
      let favoritos = JSON.parse(localStorage.getItem('meusJogosFavoritos')) || [];

      function syncFavorites() {
        document.querySelectorAll('.heart-btn').forEach(btn => {
          const id = btn.getAttribute('data-id');
          btn.classList.toggle('is-active', favoritos.includes(id));
        });
      }

      function applyFilters() {
        const query = searchBox.value.toLowerCase();
        const activeCat = document.querySelector('.filter-chip.active').getAttribute('data-cat');
        let count = 0;

        games.forEach(game => {
          const title = game.getAttribute('data-titulo');
          const cat = game.getAttribute('data-categoria');
          const id = game.getAttribute('data-id');

          const matchesSearch = title.includes(query);
          const matchesCat = activeCat === 'todos' || 
                             (activeCat === 'favoritos' ? favoritos.includes(id) : cat === activeCat);

          if (matchesSearch && matchesCat) {
            game.style.display = 'block';
            game.style.animation = 'fadeIn 0.4s ease forwards';
            count++;
          } else {
            game.style.display = 'none';
          }
        });

        emptyState.classList.toggle('hidden', count > 0);
      }

      // Listeners
      searchBox.addEventListener('input', applyFilters);
      
      filterBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          filterBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          applyFilters();
        });
      });

      // Atalho de teclado
      window.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.key === 'k') {
          e.preventDefault();
          searchBox.focus();
        }
      });

      // Inicializa√ß√£o
      syncFavorites();
    </script>
  </body>
</html>

<style>
  /* CONFIGURA√á√ÉO DE CORES E VARI√ÅVEIS */
  :root {
    --neon-pink: #ff0055;
    --neon-cyan: #00f2ff;
    --bg-dark: #08080c;
    --card-bg: rgba(255, 255, 255, 0.03);
    --glass-border: rgba(255, 255, 255, 0.1);
  }

  body {
    background-color: var(--bg-dark);
    color: white;
    margin: 0;
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    overflow-x: hidden;
  }

  /* BACKGROUND RECONSTRU√çDO (O TEU FAVORITO) */
  .space-bg {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2;
    background: radial-gradient(circle at 50% 50%, #1a0b2e 0%, #08080c 100%);
  }

  .retro-grid {
    position: absolute; width: 200%; height: 200%; bottom: -50%; left: -50%;
    background-image: 
      linear-gradient(var(--neon-pink) 1px, transparent 1px),
      linear-gradient(90deg, var(--neon-pink) 1px, transparent 1px);
    background-size: 60px 60px;
    transform: perspective(500px) rotateX(60deg);
    mask-image: linear-gradient(to top, black, transparent 80%);
    opacity: 0.15;
    animation: gridMove 15s linear infinite;
  }

  @keyframes gridMove {
    from { background-position: 0 0; }
    to { background-position: 0 60px; }
  }

  /* LOGO GLITCH */
  .glitch-logo {
    font-size: 2rem; font-weight: 900; letter-spacing: -1px; margin: 0;
    position: relative; text-shadow: 0 0 15px rgba(255, 0, 85, 0.5);
  }
  .pink { color: var(--neon-pink); }

  /* CABE√áALHO STYLE */
  .top-nav {
    display: flex; justify-content: space-between; align-items: center;
    padding: 20px 5%; background: rgba(0,0,0,0.4); backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--glass-border);
  }

  .hero-section {
    padding: 60px 5% 20px; text-align: center;
    display: flex; flex-direction: column; align-items: center; gap: 40px;
  }

  /* BARRA DE PESQUISA "CYBER" */
  .search-wrapper {
    position: relative; width: 100%; max-width: 600px;
  }
  .search-glow {
    position: absolute; inset: -2px; background: linear-gradient(90deg, var(--neon-pink), var(--neon-cyan));
    border-radius: 50px; filter: blur(10px); opacity: 0.3; z-index: -1;
  }
  #searchBox {
    width: 100%; background: #111; border: 1px solid #333; border-radius: 50px;
    padding: 18px 30px; color: white; font-size: 1.1rem; outline: none; transition: 0.3s;
  }
  #searchBox:focus { border-color: var(--neon-pink); box-shadow: 0 0 20px rgba(255,0,85,0.2); }
  
  .search-hint {
    position: absolute; right: 20px; top: 50%; transform: translateY(-50%);
    background: #222; padding: 4px 8px; border-radius: 5px; font-size: 0.7rem; color: #666;
  }

  /* FILTROS MODERNOS */
  .filter-bar { width: 100%; max-width: 1200px; overflow: hidden; }
  .filter-scroll {
    display: flex; gap: 12px; overflow-x: auto; padding: 10px 0;
    scrollbar-width: none; justify-content: flex-start;
  }
  .filter-chip {
    white-space: nowrap; background: var(--card-bg); border: 1px solid var(--glass-border);
    color: #999; padding: 10px 24px; border-radius: 12px; cursor: pointer;
    font-weight: 600; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .filter-chip:hover { background: rgba(255,255,255,0.08); color: white; }
  .filter-chip.active {
    background: var(--neon-pink); color: white; border-color: var(--neon-pink);
    box-shadow: 0 0 20px rgba(255, 0, 85, 0.4); transform: translateY(-2px);
  }

  /* GRID DE JOGOS */
  .content { padding: 40px 5%; max-width: 1600px; margin: 0 auto; }
  .game-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 30px;
  }

  .game-card-wrapper {
    transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  .game-card-wrapper:hover { transform: scale(1.05); }

  /* ESTADO VAZIO */
  #empty-state {
    text-align: center; padding: 100px 0; color: #444;
  }
  .hidden { display: none !important; }
  .empty-icon { font-size: 4rem; margin-bottom: 20px; opacity: 0.5; }

  /* SCROLLBAR */
  ::-webkit-scrollbar { width: 8px; }
  ::-webkit-scrollbar-track { background: var(--bg-dark); }
  ::-webkit-scrollbar-thumb { background: #222; border-radius: 10px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--neon-pink); }
</style>