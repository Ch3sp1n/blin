---
import GameCard from '../components/GameCard.astro';
import listaDeJogos from '../data/jogos.json';
import PerfilJogador from '../components/PerfilJogador.astro';

const categorias = [...new Set(listaDeJogos.map((jogo) => jogo.categoria))];
---

<html lang="pt">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/png" href="/logo.png" />
    <meta name="viewport" content="width=device-width" />
    <title>Gamer Portal | Retro Arcade</title>
  </head>
  <body>
    
    <div class="retro-bg"><div class="grid"></div></div>

    <header>
      <div class="header-top">
        <a href="/" class="logo-link">
          <div class="logo-text">GAMER <span class="highlight">PORTAL</span></div>
        </a>
        <PerfilJogador />
      </div>

      <div class="controls-wrapper">
        <div class="search-container">
          <input type="text" id="searchBox" placeholder="Pesquisar na biblioteca..." />
        </div>

        <div class="filters">
          <button class="filter-btn active" data-cat="todos">Todos</button>
          <button class="filter-btn fav-filter" data-cat="favoritos">‚ù§Ô∏è Favoritos</button>
          {categorias.map((cat) => (
            <button class="filter-btn" data-cat={cat}>{cat}</button>
          ))}
        </div>
      </div>
    </header>

    <main class="game-grid">
      {listaDeJogos.map((jogo) => (
        <div 
          class="game-wrapper" 
          data-titulo={jogo.titulo.toLowerCase()} 
          data-categoria={jogo.categoria}
          data-id={jogo.id}
        >
          <GameCard 
            id={jogo.id}
            titulo={jogo.titulo} 
            thumb={jogo.imagem || "/capas/placeholder.jpg"} 
            categoria={jogo.categoria} 
          />
        </div>
      ))}
    </main>
    
    <p id="no-results">Nenhum jogo encontrado... üò¢</p>

    <script is:inline>
      const searchBox = document.getElementById('searchBox');
      const filterBtns = document.querySelectorAll('.filter-btn');
      const games = document.querySelectorAll('.game-wrapper');
      const noResults = document.getElementById('no-results');
      
      let favoritos = JSON.parse(localStorage.getItem('meusJogosFavoritos')) || [];

      function atualizarCoracoes() {
        document.querySelectorAll('.heart-btn').forEach(btn => {
          const id = btn.getAttribute('data-id');
          if (favoritos.includes(id)) btn.classList.add('liked');
          else btn.classList.remove('liked');
        });
      }

      function filtrar() {
        const termo = searchBox.value.toLowerCase();
        let visiveis = 0;
        const catAtual = document.querySelector('.filter-btn.active').getAttribute('data-cat');

        games.forEach((game) => {
          const titulo = game.getAttribute('data-titulo');
          const catJogo = game.getAttribute('data-categoria');
          const idJogo = game.getAttribute('data-id');

          const matchTexto = titulo.includes(termo);
          const matchCat = catAtual === 'todos' || (catAtual === 'favoritos' ? favoritos.includes(idJogo) : catJogo === catAtual);

          if (matchTexto && matchCat) {
            game.style.display = 'block';
            visiveis++;
          } else {
            game.style.display = 'none';
          }
        });

        noResults.style.display = visiveis > 0 ? 'none' : 'block';
      }

      // Event Listeners
      searchBox.addEventListener('input', filtrar);
      filterBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          filterBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          filtrar();
        });
      });

      // Clique nos cora√ß√µes (Event Delegation)
      document.addEventListener('click', (e) => {
        const btn = e.target.closest('.heart-btn');
        if (btn) {
          const id = btn.getAttribute('data-id');
          if (favoritos.includes(id)) favoritos = favoritos.filter(f => f !== id);
          else favoritos.push(id);
          localStorage.setItem('meusJogosFavoritos', JSON.stringify(favoritos));
          atualizarCoracoes();
          filtrar();
        }
      });

      atualizarCoracoes();
    </script>
  </body>
</html>

<style>
  /* DE VOLTA AO VISUAL BONITO */
  body { background-color: #050505; color: white; margin: 0; font-family: 'Segoe UI', sans-serif; overflow-x: hidden; }

  .retro-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; perspective: 1000px; }
  .grid {
    position: absolute; width: 200%; height: 200%; top: -50%; left: -50%;
    background-image: linear-gradient(rgba(255, 0, 85, 0.2) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 0, 85, 0.2) 1px, transparent 1px);
    background-size: 50px 50px; transform: rotateX(60deg); animation: move 20s linear infinite;
  }
  @keyframes move { from { background-position: 0 0; } to { background-position: 0 50px; } }

  header { padding: 40px 20px; display: flex; flex-direction: column; align-items: center; gap: 30px; }
  .header-top { width: 100%; max-width: 1200px; display: flex; justify-content: space-between; align-items: center; }

  .logo-text { font-size: 3rem; font-weight: 900; font-style: italic; letter-spacing: -2px; text-shadow: 0 0 20px rgba(255, 0, 85, 0.5); }
  .highlight { color: #ff0055; }

  .search-container input {
    background: rgba(20, 20, 20, 0.8); border: 2px solid #333; color: white;
    padding: 15px 30px; border-radius: 50px; width: 400px; outline: none; transition: 0.3s;
    backdrop-filter: blur(10px);
  }
  .search-container input:focus { border-color: #ff0055; box-shadow: 0 0 15px rgba(255, 0, 85, 0.3); }

  .filters { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
  .filter-btn {
    background: #1a1a1a; border: 1px solid #333; color: #888; padding: 8px 20px;
    border-radius: 20px; cursor: pointer; transition: 0.3s; font-weight: 600;
  }
  .filter-btn.active { background: #ff0055; color: white; border-color: #ff0055; box-shadow: 0 0 15px rgba(255, 0, 85, 0.4); }

  .game-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 30px; padding: 40px; max-width: 1400px; margin: 0 auto;
  }

  #no-results { text-align: center; color: #666; display: none; margin-top: 50px; font-size: 1.2rem; }

  /* Cora√ß√£o rosa n√©on */
  :global(.liked) { color: #ff0055 !important; filter: drop-shadow(0 0 5px #ff0055); }
</style>