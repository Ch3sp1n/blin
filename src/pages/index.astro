---
import GameCard from '../components/GameCard.astro';
import listaDeJogos from '../data/jogos.json';
import PerfilJogador from '../components/PerfilJogador.astro';

const categorias = [...new Set(listaDeJogos.map((jogo) => jogo.categoria))];
---

<html lang="pt">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/png" href="/logo.png" />
    <meta name="viewport" content="width=device-width" />
    <title>Gamer Portal</title>

    <script is:inline>
      (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','GTM-PQHFF59B');
    </script>
  </head>
  
  <body>
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PQHFF59B"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    
    <div class="retro-bg"><div class="grid"></div></div>

    <header>
      <a href="/" class="logo-link">
        <div class="logo-text">GAMER <span class="highlight">PORTAL</span></div>
      </a>

      <PerfilJogador />
      
      <div class="search-container">
        <input type="text" id="searchBox" placeholder="Pesquisar jogos..." />
      </div>

      <div class="filters">
        <button class="filter-btn active" data-cat="todos">Todos</button>
        <button class="filter-btn fav-filter" data-cat="favoritos">‚ù§Ô∏è Favoritos</button>

        {categorias.map((cat) => (
          <button class="filter-btn" data-cat={cat}>{cat}</button>
        ))}
      </div>
    </header>

    <main class="game-grid">
      {listaDeJogos.map((jogo) => (
        <div 
          class="game-wrapper" 
          data-titulo={jogo.titulo.toLowerCase()} 
          data-categoria={jogo.categoria}
          data-id={jogo.id}
        >
          <GameCard 
            id={jogo.id}
            titulo={jogo.titulo} 
            thumb={jogo.imagem} 
            categoria={jogo.categoria} 
          />
        </div>
      ))}
    </main>
    
    <p id="no-results" style="display: none; text-align: center; color: #aaa; margin-top: 20px; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 10px;">
      Nenhum jogo encontrado... üò¢
    </p>

    <script is:inline>
      // Selecionamos os elementos aqui dentro para garantir que o script os "v√™"
      const searchBox = document.getElementById('searchBox');
      const filterBtns = document.querySelectorAll('.filter-btn');
      const games = document.querySelectorAll('.game-wrapper');
      const noResults = document.getElementById('no-results');
      
      // Criamos uma fun√ß√£o de seguran√ßa para o localStorage
      const getFavoritos = () => {
        try {
          return JSON.parse(localStorage.getItem('meusJogosFavoritos')) || [];
        } catch (e) {
          return [];
        }
      };

      let favoritos = getFavoritos();
      let categoriaAtual = 'todos';

      function atualizarCoracoes() {
        document.querySelectorAll('.heart-btn').forEach(btn => {
          const id = btn.getAttribute('data-id');
          if (favoritos.includes(id)) {
            btn.classList.add('liked');
          } else {
            btn.classList.remove('liked');
          }
        });
      }

      function filtrar() {
        const termo = searchBox.value.toLowerCase();
        let visiveis = 0;

        games.forEach((game) => {
          const titulo = game.getAttribute('data-titulo');
          const catJogo = game.getAttribute('data-categoria');
          const idJogo = game.getAttribute('data-id');

          const matchTexto = titulo.includes(termo);
          let matchCat = false;

          if (categoriaAtual === 'favoritos') {
            matchCat = favoritos.includes(idJogo);
          } else {
            matchCat = categoriaAtual === 'todos' || catJogo === categoriaAtual;
          }

          if (matchTexto && matchCat) {
            game.style.display = 'block';
            visiveis++;
          } else {
            game.style.display = 'none';
          }
        });

        if (noResults) {
            noResults.style.display = visiveis > 0 ? 'none' : 'block';
            noResults.textContent = (visiveis === 0 && categoriaAtual === 'favoritos') 
                ? "Ainda n√£o tens favoritos! Clica nos ‚ù§Ô∏è" 
                : "Nenhum jogo encontrado... üò¢";
        }
      }

      // Event Listeners para Cora√ß√µes
      document.addEventListener('click', (e) => {
        if (e.target.closest('.heart-btn')) {
          const btn = e.target.closest('.heart-btn');
          const id = btn.getAttribute('data-id');
          
          if (favoritos.includes(id)) {
            favoritos = favoritos.filter(favId => favId !== id);
          } else {
            favoritos.push(id);
          }
          localStorage.setItem('meusJogosFavoritos', JSON.stringify(favoritos));
          atualizarCoracoes();
          if (categoriaAtual === 'favoritos') filtrar();
        }
      });

      // Inicializa√ß√£o segura
      if (searchBox) searchBox.addEventListener('input', filtrar);
      
      filterBtns.forEach((btn) => {
        btn.addEventListener('click', () => {
          filterBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          categoriaAtual = btn.getAttribute('data-cat');
          filtrar();
        });
      });

      atualizarCoracoes();
    </script>

    <style>
      /* Teu estilo CSS mant√©m-se igual */
      body { background-color: #050505; color: white; margin: 0; font-family: sans-serif; }
      .game-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; padding: 20px; }
      .retro-bg { position: fixed; z-index: -1; width: 100%; height: 100%; }
      .highlight { color: #ff0055; }
      .filter-btn.active { background: #ff0055; color: white; }
      .liked { color: #ff0055 !important; }
    </style>
  </body>
</html>